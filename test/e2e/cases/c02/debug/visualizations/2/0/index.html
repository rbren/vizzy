<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <link rel="stylesheet" href="/assets/iframe.css">
    <script src="/assets/iframe.js"></script>
    <style>
        body {
            background-color: black;
            color: white;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Test: c02</h1>
    <h3>Prompt: Plot the difference between C02 and adjusted levels over time</h3>
    <h4>2/0</h4>
    <h3>CO2 Difference Over Time</h3>
    <div id="visualization"><svg></svg></div>

    <script>
async function drawVisualization(svg, dataString) {
  // Parsing the CSV data
  const data = d3.csvParse(dataString, d => {
    return {
      date: d3.timeParse("%Y-%m-%d")(d.Date),
      co2: +d.CO2,
      adjustedCo2: +d["adjusted CO2"],
      difference: +d.CO2 - +d["adjusted CO2"]
    };
  });

  // Sanitizing the data: Remove entries with missing or null values
  const filteredData = data.filter(d => !isNaN(d.difference) && d.date);

  if (filteredData.length === 0) {
    throw new Error("No valid data points");
  }

  // Setting up dimensions
  const margin = {top: 20, right: 30, bottom: 30, left: 40},
      width = +svg.attr('width') - margin.left - margin.right,
      height = +svg.attr('height') - margin.top - margin.bottom;

  // Scales
  const x = d3.scaleTime()
    .domain(d3.extent(filteredData, d => d.date))
    .range([margin.left, width - margin.right]);

  const y = d3.scaleLinear()
    .domain([d3.min(filteredData, d => d.difference), d3.max(filteredData, d => d.difference)])
    .nice()
    .range([height - margin.bottom, margin.top]);

  // Axes
  const xAxis = g => g
    .attr("transform", `translate(0,${height - margin.bottom})`)
    .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0))
    .attr("color", "#fff");

  const yAxis = g => g
    .attr("transform", `translate(${margin.left},0)`)
    .call(d3.axisLeft(y))
    .call(g => g.select(".domain").remove())
    .call(g => g.select(".tick:last-of-type text").clone()
        .attr("x", 3)
        .attr("text-anchor", "start")
        .attr("font-weight", "bold")
        .text(data.y))
    .attr("color", "#fff");

  // Drawing the line
  const line = d3.line()
    .defined(d => !isNaN(d.difference))
    .x(d => x(d.date))
    .y(d => y(d.difference));

  svg.append("g")
    .call(xAxis);

  svg.append("g")
    .call(yAxis);

  svg.append("path")
    .datum(filteredData)
    .attr("fill", "none")
    .attr("stroke", "white")
    .attr("stroke-width", 1.5)
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("d", line);

  // Optional: Add axis labels, title, etc. here according to the requirements.
}
</script>

    <script>

        
        fetch("\/c02\/data")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                setUpEnvironment({
                    data: data,
                    code: drawVisualization.toString(),
                    id: 'test',
                    origin: window.location.origin,
                    heightOffset: 300,
                    widthOffset: 100,
                });
                window.rerun();
            })
            .catch(error => {
                console.error("Caught error", error);
                alert(error)
            });
    </script>
</body>
</html>

